<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders ‚Äî GreenHaven Nursery</title>
    <meta name="description" content="Manage orders, track sales history, and place new orders">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>
        <button class="sidebar-toggle no-print">‚ò∞</button>

        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Orders</h1>
                    <p class="page-subtitle">Manage orders and sales history</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openNewOrder()">+ New Order</button>
                </div>
            </div>

            <div class="page-body">
                <!-- Status Filters -->
                <div class="filter-tabs mb-3">
                    <button class="filter-tab active" onclick="filterOrders(this, '')">All</button>
                    <button class="filter-tab" onclick="filterOrders(this, 'pending')">‚è≥ Pending</button>
                    <button class="filter-tab" onclick="filterOrders(this, 'completed')">‚úÖ Completed</button>
                    <button class="filter-tab" onclick="filterOrders(this, 'cancelled')">‚ùå Cancelled</button>
                </div>

                <!-- Orders Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-wrapper" id="ordersTable">
                            <div class="skeleton skeleton-row"></div>
                            <div class="skeleton skeleton-row"></div>
                            <div class="skeleton skeleton-row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal" style="max-width:640px;">
            <div class="modal-header">
                <h2>Place New Order</h2>
                <button class="modal-close" onclick="closeModal('orderModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderCustomer">Customer</label>
                        <select id="orderCustomer" class="form-control">
                            <option value="">Walk-in Customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orderPayment">Payment Mode</label>
                        <select id="orderPayment" class="form-control">
                            <option value="cash">üíµ Cash</option>
                            <option value="online">üí≥ Online</option>
                        </select>
                    </div>
                </div>

                <label
                    style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:block;">Order
                    Items</label>
                <div id="orderItems">
                    <!-- Dynamic items -->
                </div>
                <button class="btn btn-sm btn-secondary mt-2" onclick="addOrderItem()">+ Add Item</button>

                <div class="flex-between mt-3"
                    style="padding:14px;background:var(--bg-glass);border-radius:var(--radius-sm);">
                    <span style="font-weight:600;">Total</span>
                    <span id="orderTotal" style="font-size:20px;font-weight:800;color:var(--accent-green);">‚Çπ0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderModal')">Cancel</button>
                <button class="btn btn-primary" onclick="placeOrder()">Place Order</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let plantsForOrder = [];
        let customersForOrder = [];
        let currentStatusFilter = '';

        async function loadOrders(status = '') {
            try {
                let url = 'orders.php?limit=100';
                if (status) url += `&status=${status}`;
                const res = await api.get(url);
                const orders = res.data || [];

                if (orders.length === 0) {
                    document.getElementById('ordersTable').innerHTML = '<div class="empty-state"><div class="empty-icon">üõí</div><h3>No orders found</h3><p>Place your first order!</p></div>';
                    return;
                }

                document.getElementById('ordersTable').innerHTML = `
                    <table>
                        <thead><tr><th>Order #</th><th>Customer</th><th>Amount</th><th>Payment</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody>
                            ${orders.map(o => `
                                <tr>
                                    <td><strong>#${o.id}</strong></td>
                                    <td>${o.customer_name || 'Walk-in'}</td>
                                    <td><strong>${formatCurrency(o.total_amount)}</strong></td>
                                    <td>${o.payment_mode === 'online' ? 'üí≥ Online' : 'üíµ Cash'}</td>
                                    <td>${getStatusBadge(o.status)}</td>
                                    <td class="text-muted">${formatDateTime(o.created_at)}</td>
                                    <td>
                                        <div style="display:flex;gap:4px;">
                                            ${o.status === 'pending' ? `
                                                <button class="btn btn-sm btn-primary" onclick="updateStatus(${o.id}, 'completed')">‚úÖ</button>
                                                <button class="btn btn-sm btn-danger" onclick="updateStatus(${o.id}, 'cancelled')">‚ùå</button>
                                            ` : ''}
                                            <a href="bills.html?order_id=${o.id}" class="btn btn-sm btn-secondary">üßæ</a>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                showToast('Failed to load orders', 'error');
            }
        }

        function filterOrders(btn, status) {
            document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentStatusFilter = status;
            loadOrders(status);
        }

        async function openNewOrder() {
            try {
                const [plantsRes, custRes] = await Promise.all([
                    api.get('plants.php?limit=500'),
                    api.get('customers.php')
                ]);
                plantsForOrder = (plantsRes.data || []).filter(p => p.quantity > 0);
                customersForOrder = custRes.data || [];

                document.getElementById('orderCustomer').innerHTML =
                    '<option value="">Walk-in Customer</option>' +
                    customersForOrder.map(c => `<option value="${c.id}">${c.name} (${c.phone || c.email || ''})</option>`).join('');

                document.getElementById('orderItems').innerHTML = '';
                addOrderItem();
                updateOrderTotal();
                openModal('orderModal');
            } catch (err) {
                showToast('Failed to load data', 'error');
            }
        }

        let itemCount = 0;
        function addOrderItem() {
            itemCount++;
            const html = `
            <div class="form-row mb-2" id="orderItem${itemCount}" style="align-items:end;">
                <div class="form-group" style="flex:2;">
                    <select class="form-control item-plant" onchange="updateOrderTotal()">
                        <option value="">Select plant</option>
                        ${plantsForOrder.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.quantity}">${p.name} ‚Äî ${formatCurrency(p.price)} (${p.quantity} left)</option>`).join('')}
                    </select>
                </div>
                <div class="form-group" style="flex:1;">
                    <input type="number" class="form-control item-qty" min="1" value="1" onchange="updateOrderTotal()" placeholder="Qty">
                </div>
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('orderItem${itemCount}').remove(); updateOrderTotal();" style="height:38px;">üóëÔ∏è</button>
            </div>`;
            document.getElementById('orderItems').insertAdjacentHTML('beforeend', html);
        }

        function updateOrderTotal() {
            let total = 0;
            document.querySelectorAll('#orderItems .form-row').forEach(row => {
                const sel = row.querySelector('.item-plant');
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const opt = sel.options[sel.selectedIndex];
                const price = parseFloat(opt?.dataset?.price || 0);
                total += price * qty;
            });
            document.getElementById('orderTotal').textContent = formatCurrency(total);
        }

        async function placeOrder() {
            const items = [];
            document.querySelectorAll('#orderItems .form-row').forEach(row => {
                const sel = row.querySelector('.item-plant');
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const opt = sel.options[sel.selectedIndex];
                if (sel.value && qty > 0) {
                    items.push({
                        plant_id: parseInt(sel.value),
                        quantity: qty,
                        unit_price: parseFloat(opt.dataset.price || 0)
                    });
                }
            });

            if (items.length === 0) {
                showToast('Please add at least one item', 'warning');
                return;
            }

            try {
                const customerId = document.getElementById('orderCustomer').value;
                await api.post('orders.php', {
                    customer_id: customerId ? parseInt(customerId) : null,
                    payment_mode: document.getElementById('orderPayment').value,
                    items
                });
                showToast('Order placed!', 'success');
                closeModal('orderModal');
                loadOrders(currentStatusFilter);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function updateStatus(id, status) {
            try {
                await api.put('orders.php', { id, status });
                showToast(`Order #${id} marked as ${status}`, 'success');
                loadOrders(currentStatusFilter);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        loadOrders();
    </script>
</body>

</html>