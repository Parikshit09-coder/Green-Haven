<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice ‚Äî GreenHaven Nursery</title>
    <meta name="description" content="View and print invoices for orders">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>
        <button class="sidebar-toggle no-print">‚ò∞</button>

        <main class="main-content">
            <div class="page-header no-print">
                <div>
                    <h1 class="page-title">Bills & Invoices</h1>
                    <p class="page-subtitle">View and print invoices</p>
                </div>
                <div class="header-actions">
                    <div class="search-bar" style="max-width:200px;">
                        <span class="search-icon">#</span>
                        <input type="number" id="orderIdInput" placeholder="Order ID" style="padding-left:32px;">
                    </div>
                    <button class="btn btn-primary" onclick="loadInvoice()">Load Invoice</button>
                    <button class="btn btn-secondary" id="printBtn" onclick="window.print()" style="display:none;">üñ®Ô∏è
                        Print</button>
                </div>
            </div>

            <div class="page-body">
                <div id="invoiceArea">
                    <div class="empty-state">
                        <div class="empty-icon">üßæ</div>
                        <h3>No Invoice Loaded</h3>
                        <p>Enter an Order ID above or navigate here from the Orders page</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Auto-load from URL param
        const params = new URLSearchParams(window.location.search);
        const urlOrderId = params.get('order_id');
        if (urlOrderId) {
            document.getElementById('orderIdInput').value = urlOrderId;
            document.addEventListener('DOMContentLoaded', () => setTimeout(loadInvoice, 300));
        }

        async function loadInvoice() {
            const orderId = document.getElementById('orderIdInput').value;
            if (!orderId) { showToast('Enter an Order ID', 'warning'); return; }

            try {
                const data = await api.get(`bills.php?order_id=${orderId}`);
                const items = data.items || [];

                document.getElementById('printBtn').style.display = 'inline-flex';
                document.getElementById('invoiceArea').innerHTML = `
                <div class="invoice-container">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;border-bottom:2px solid #00b377;padding-bottom:20px;">
                        <div>
                            <h1 style="font-size:28px;margin-bottom:4px;">üåø ${data.business_name}</h1>
                            <p style="color:#777;font-size:13px;">${data.business_address}</p>
                        </div>
                        <div style="text-align:right;">
                            <h2 style="color:#00b377;font-size:22px;margin-bottom:4px;">INVOICE</h2>
                            <p style="font-size:14px;color:#555;">${data.invoice_number}</p>
                            <p style="font-size:13px;color:#888;">${formatDate(data.invoice_date)}</p>
                        </div>
                    </div>

                    <div style="display:flex;justify-content:space-between;margin-bottom:30px;">
                        <div>
                            <p style="font-size:11px;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Bill To</p>
                            <p style="font-weight:600;font-size:16px;">${data.customer_name || 'Walk-in Customer'}</p>
                            <p style="color:#777;font-size:13px;">${data.customer_phone || ''}</p>
                            <p style="color:#777;font-size:13px;">${data.customer_email || ''}</p>
                            <p style="color:#777;font-size:13px;">${data.customer_address || ''}</p>
                        </div>
                        <div style="text-align:right;">
                            <p style="font-size:11px;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Payment</p>
                            <p style="font-weight:600;">${data.payment_mode === 'online' ? 'üí≥ Online' : 'üíµ Cash'}</p>
                            <p style="font-size:13px;color:#777;">Status: <strong style="color:${data.status === 'completed' ? '#00b377' : '#ff9f43'}">${data.status.toUpperCase()}</strong></p>
                        </div>
                    </div>

                    <table style="margin-bottom:24px;">
                        <thead>
                            <tr><th style="width:40%;">Item</th><th>Category</th><th style="text-align:right;">Price</th><th style="text-align:right;">Qty</th><th style="text-align:right;">Total</th></tr>
                        </thead>
                        <tbody>
                            ${items.map(i => `
                                <tr>
                                    <td><strong>${i.plant_name || 'Unknown'}</strong></td>
                                    <td>${i.plant_category || '‚Äî'}</td>
                                    <td style="text-align:right;">${formatCurrency(i.unit_price)}</td>
                                    <td style="text-align:right;">${i.quantity}</td>
                                    <td style="text-align:right;"><strong>${formatCurrency(i.unit_price * i.quantity)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="text-align:right;padding:20px;background:#f8f9fa;border-radius:8px;">
                        <span style="font-size:14px;color:#777;">Grand Total</span><br>
                        <span class="invoice-total">${formatCurrency(data.total_amount)}</span>
                    </div>

                    <div style="text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #eee;color:#aaa;font-size:12px;">
                        Thank you for your purchase! üå±<br>
                        Generated by GreenHaven Nursery Management System
                    </div>
                </div>
                `;
            } catch (err) {
                showToast('Invoice not found', 'error');
            }
        }
    </script>
</body>

</html>